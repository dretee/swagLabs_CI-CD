name: Selenium Test Workflow

on: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  run-selenium-tests:
    name: Run Selenium Tests
    runs-on: ubuntu-latest
    
    steps:
      # Checkout code from the repo
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      
      # Cache Python dependencies
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Install Chrome and ChromeDriver
      - name: Set up Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          wget -N https://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv -f chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver
        env:
          CHROME_BIN: /usr/bin/google-chrome
          CHROME_DRIVER: /usr/local/bin/chromedriver

      # Install dependencies including allure-pytest
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install allure-pytest pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Run Selenium tests with Allure report generation
      - name: Run Selenium Tests with Allure
        run: |
          cd test
          mkdir -p allure-results
          pytest --alluredir=allure-results testLogin.py --browser=chrome --maxfail=1
        continue-on-error: true # Optionally let the pipeline continue if tests fail

      # Install Allure command-line tool
      - name: Install Allure
        run: |
          sudo apt-add-repository ppa:qameta/allure
          sudo apt-get update
          sudo apt-get install allure

      # Generate Allure Report
      - name: Generate Allure Report
        run: allure generate allure-results --clean -o allure-report

      # Upload Allure Report as an artifact
      - name: Upload Allure Report
        uses: actions/upload-artifact@v3
        with:
          name: allure-report
          path: allure-report/

      # Send email notification if tests fail
      - name: Send Email Notification on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.example.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Selenium Test Failure"
          body: "Tests failed for ${{ github.repository }} at ${{ github.ref }}."
          to: testdantown@gmail.com
          from: uyahanthony008@gmail.com
